{% extends "admin/base_site.html" %}
{% load static %}

{% block extrastyle %}
{{ block.super }}
<style>
.form-row {
    margin-bottom: 1em;
    overflow: hidden;
    display: flex;
    flex-direction: column;
}

.form-row label {
    display: block;
    padding: 0 10px 0 0;
    margin-bottom: 5px;
    font-weight: bold;
    color: var(--body-quiet-color);
}

.form-row input[type="text"],
.form-row textarea {
    width: 100%;
    padding: 8px;
    box-sizing: border-box;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    background-color: var(--body-bg);
    color: var(--body-fg);
}

.form-row select {
    width: 100%;
    padding: 8px 12px;
    box-sizing: border-box;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    background-color: var(--body-bg);
    color: var(--body-fg);
    height: 38px;
    line-height: 1.5;
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
    background-image: url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%23666' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14L2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 12px center;
    padding-right: 32px;
}

.form-row select:focus {
    border-color: var(--body-quiet-color);
    outline: none;
}

.form-row input[type="text"]:focus,
.form-row textarea:focus {
    border-color: var(--body-quiet-color);
    outline: none;
}

#compose-form-container {
    padding: 20px;
    margin: 20px;
    background: var(--body-bg);
    border-radius: 4px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.submit-row {
    margin-top: 20px;
    text-align: right;
    padding: 12px;
    background: var(--darkened-bg);
    border-radius: 4px;
}

.submit-row input[type="submit"] {
    background: var(--button-bg);
    padding: 10px 15px;
    color: var(--button-fg);
    border: none;
    border-radius: 4px;
    cursor: pointer;
}

.submit-row input[type="submit"]:hover {
    background: var(--button-hover-bg);
}

.tox-tinymce {
    border-radius: 4px !important;
}

/* Dark mode support for select dropdown arrow */
@media (prefers-color-scheme: dark) {
    .form-row select {
        background-image: url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%23fff' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14L2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
    }
}
</style>
{% endblock %}

{% block content %}
<div class="module" id="compose-form-container">
    <h2>Compose Message</h2>
    
    <form method="post" id="compose-form">
        {% csrf_token %}
        
        <div class="form-row">
            <label for="channel">Channel:</label>
            <select name="channel" id="channel" required>
                <option value="">Select a channel</option>
                {% for channel in channels %}
                    <option value="{{ channel.id }}" data-platform="{{ channel.platform }}">{{ channel.name }} ({{ channel.platform }})</option>
                {% endfor %}
            </select>
        </div>

        <!-- Telegram-specific fields -->
        <div id="telegram-fields" style="display: none;">
            <div class="form-row">
                <label for="chat_id">Chat ID:</label>
                <input type="text" name="chat_id" id="chat_id">
            </div>
            <div class="form-row">
                <label for="telegram-text">Message:</label>
                <textarea name="text" id="telegram-text" rows="5"></textarea>
            </div>
        </div>

        <!-- Email-specific fields -->
        <div id="email-fields" style="display: none;">
            <div class="form-row">
                <label for="to">To:</label>
                <input type="text" name="to" id="to" placeholder="Comma-separated email addresses">
            </div>
            <div class="form-row">
                <label for="cc">CC:</label>
                <input type="text" name="cc" id="cc" placeholder="Comma-separated email addresses">
            </div>
            <div class="form-row">
                <label for="bcc">BCC:</label>
                <input type="text" name="bcc" id="bcc" placeholder="Comma-separated email addresses">
            </div>
            <div class="form-row">
                <label for="subject">Subject:</label>
                <input type="text" name="subject" id="subject">
            </div>
            <div class="form-row">
                <label for="email-body">Message:</label>
                <textarea id="email-body" name="html"></textarea>
            </div>
        </div>

        <div class="submit-row">
            <input type="submit" value="Send Message" class="default">
        </div>
    </form>
</div>

{% if tinymce_api_key %}
  <script src="https://cdn.tiny.cloud/1/{{ tinymce_api_key }}/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>
{% else %}
  {# Fallback to TinyMCE's limited no-api-key usage #}
  <script src="https://cdn.tiny.cloud/1/no-api-key/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>
{% endif %}

<script>
let editor = null;

// Function to update URL parameters
function updateUrlParams(params) {
    const url = new URL(window.location.href);
    Object.entries(params).forEach(([key, value]) => {
        if (value) {
            url.searchParams.set(key, value);
        } else {
            url.searchParams.delete(key);
        }
    });
    window.history.replaceState({}, '', url);
}

// Function to get URL parameters
function getUrlParams() {
    const params = new URLSearchParams(window.location.search);
    return Object.fromEntries(params.entries());
}

// Function to pre-fill form fields from URL parameters
function prefillFromUrl() {
    const params = getUrlParams();
    
    // Pre-fill channel and trigger change event if specified
    if (params.channel) {
        const channelSelect = document.getElementById('channel');
        channelSelect.value = params.channel;
        channelSelect.dispatchEvent(new Event('change'));
    }
    
    // Pre-fill Telegram fields
    if (params.chat_id) {
        document.getElementById('chat_id').value = params.chat_id;
    }
    if (params.text) {
        document.getElementById('telegram-text').value = params.text;
    }
    
    // Pre-fill Email fields
    if (params.to) {
        document.getElementById('to').value = params.to;
    }
    if (params.cc) {
        document.getElementById('cc').value = params.cc;
    }
    if (params.bcc) {
        document.getElementById('bcc').value = params.bcc;
    }
    if (params.subject) {
        document.getElementById('subject').value = params.subject;
    }
    // Note: HTML content should be handled with care due to potential security issues
    if (params.html && editor) {
        editor.setContent(decodeURIComponent(params.html));
    }
}

function initEditor() {
    if (editor) {
        editor.remove();
    }
    
    editor = tinymce.init({
        selector: '#email-body',
        plugins: 'link image lists table code',
        toolbar: 'undo redo | blocks | bold italic | alignleft aligncenter alignright | indent outdent | bullist numlist | code | table',
        height: 400,
        max_height: 400,
        menubar: false,
        branding: false,
        promotion: false,
        setup: function(ed) {
            editor = ed;
            editor.on('change', function() {
                editor.save();
                // Don't update URL with HTML content as it could be very large
                // and potentially contain sensitive information
            });
            
            // If there's HTML content in URL params, set it after editor is ready
            const params = getUrlParams();
            if (params.html) {
                editor.setContent(decodeURIComponent(params.html));
            }
        }
    });
}

// Initialize editor when form becomes visible
document.addEventListener('DOMContentLoaded', function() {
    const emailFields = document.getElementById('email-fields');
    const channelSelect = document.getElementById('channel');
    const form = document.getElementById('compose-form');
    
    // Add input event listeners to update URL parameters
    const urlUpdatingInputs = {
        'channel': channelSelect,
        'chat_id': document.getElementById('chat_id'),
        'text': document.getElementById('telegram-text'),
        'to': document.getElementById('to'),
        'cc': document.getElementById('cc'),
        'bcc': document.getElementById('bcc'),
        'subject': document.getElementById('subject')
    };
    
    Object.entries(urlUpdatingInputs).forEach(([param, element]) => {
        if (element) {
            element.addEventListener('input', function() {
                updateUrlParams({ [param]: this.value });
            });
        }
    });
    
    channelSelect.addEventListener('change', function() {
        const platform = this.options[this.selectedIndex].getAttribute('data-platform');
        const showEmail = platform === 'Email';
        const showTelegram = platform === 'Telegram';
        
        document.getElementById('telegram-fields').style.display = showTelegram ? 'block' : 'none';
        emailFields.style.display = showEmail ? 'block' : 'none';
        
        if (showEmail) {
            initEditor();
        }
        
        // Update URL with channel and platform
        updateUrlParams({
            'channel': this.value,
            'platform': platform
        });
    });
    
    // Pre-fill form fields from URL parameters
    prefillFromUrl();
});
</script>
{% endblock %} 